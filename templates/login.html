{% extends "base.html" %}
{% load static %}

{% block title %}login | Complaint Management System{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'login.css' %}">
{% endblock %}

{% block content %}
<div class="card">
  <h2>Login</h2>
  <p>Welcome back! Please login to continue.</p>

  <form onsubmit="event.preventDefault()">
    {% csrf_token %}

    <label for="username">Username</label>
    <input type="text" id="username" name="text" placeholder="Enter Username" required autocomplete="on">
    <label for="password">Password</label>
    <input type="password" id="password" name="password" placeholder="Enter password" required autocomplete="on">
    <span id="error" style="display:block; margin-top:10px; text-align:center;color:red;"></span>
    <button type="submit" class="btn" onclick="loginUser()">Login</button>
  </form>

  <div class="extra">
    Don’t have an account?
    <a href="{% url 'register' %}">Register</a>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script >
  async function loginUser() {
    const username = document.getElementById("username").value;
    const password = document.getElementById("password").value;
  
    const res = await fetch("http://127.0.0.1:8000/api/token/", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ username, password })
    });
  
    const data = await res.json();
    if (res.ok) {
      localStorage.setItem("access", data.access);
      localStorage.setItem("refresh", data.refresh);
     
    
    const profileRes = await fetch("http://127.0.0.1:8000/api/profile/", {//return Response
      headers: {
        "Authorization": "Bearer " + data.access
      }
    });
  
    const profileData = await profileRes.json();
  
    if (profileData.is_superuser) {
      alert("Admin login Successful ✅");
      setTimeout(() => {
        window.location.href = "{% url 'admin_dashboard' %}";
      }, 300);
    } 
    else {
      alert("User Login Successful ✅");
      setTimeout(() => {
        window.location.href = "{% url 'raise_complaint' %}";
      }, 300);
      
    }

    }
     else {
      const err=document.getElementById("error");
      if (document.getElementById("username").value === "" || document.getElementById("password").value === ""){
        err.innerText="Please Fill the form!";
      }
      else{
        err.innerText="User not Exists!";
      }
    }
  }
</script>
{% endblock %}
